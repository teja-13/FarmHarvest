{% extends "layout.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-light border-0 shadow">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div>
                        <h2><i class="fas fa-seedling text-success me-2"></i>Crop Recommendations</h2>
                        <p class="lead">Based on your soil test results, here are the best crops to grow</p>
                    </div>
                    <img src="https://pixabay.com/get/g94c6235f738b162d56138204a65aee8bd9cd64cc71187c9bcf71b6fd8f0bbd94e6d6a367c159d56749146f09041667237f697f71a9f497c1855adb06c2300e63_1280.jpg" 
                         alt="Crops" class="img-fluid rounded ms-auto" style="max-width: 200px;">
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row" id="recommendations-container">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-body text-center py-5">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Analyzing soil data and generating recommendations...</p>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4 d-none" id="recommendations-result">
    <div class="col-md-8">
        <div class="card shadow mb-4">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="fas fa-leaf me-2"></i>Top Recommended Crops</h4>
                <button class="btn btn-light btn-sm" id="download-pdf">
                    <i class="fas fa-file-pdf me-2"></i>Download PDF
                </button>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="crop-list">
                    <!-- Crop recommendations will be populated here by JavaScript -->
                </div>
            </div>
        </div>
        
        <div class="card shadow" id="selected-crop-card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-info-circle me-2"></i><span id="selected-crop-title">Crop Information</span></h4>
            </div>
            <div class="card-body">
                <div id="crop-details">
                    <!-- Selected crop details will be populated here by JavaScript -->
                    <p class="text-muted text-center">Select a crop from the list to view details</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card shadow mb-4">
            <div class="card-header bg-info text-white">
                <h4 class="mb-0"><i class="fas fa-flask me-2"></i>Soil Analysis</h4>
            </div>
            <div class="card-body">
                <div id="soil-summary">
                    <!-- Soil test summary will be populated here by JavaScript -->
                </div>
            </div>
        </div>
        
        <div class="card shadow">
            <div class="card-header bg-warning text-dark">
                <h4 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Recommendations</h4>
            </div>
            <div class="card-body">
                <h5>Soil Improvement</h5>
                <ul class="mb-4" id="soil-improvements">
                    <!-- Soil improvement recommendations will be populated here -->
                </ul>
                
                <h5>Other Considerations</h5>
                <div id="other-considerations">
                    <p>Consider these factors for optimal crop growth:</p>
                    <ul>
                        <li>Local climate and weather patterns</li>
                        <li>Seasonal timing for planting</li>
                        <li>Water availability and irrigation methods</li>
                        <li>Local pest and disease prevalence</li>
                        <li>Previous crop rotation history</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="{{ url_for('static', filename='data/crop_data.js') }}"></script>
<script src="{{ url_for('static', filename='js/ml_api.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Simulate loading the current soil test data
        let soilTestData;
        try {
            soilTestData = JSON.parse(localStorage.getItem('currentSoilTest'));
        } catch (e) {
            console.error('Error loading soil test data:', e);
        }
        
        // If no soil test data is found, show a message
        if (!soilTestData) {
            document.getElementById('recommendations-container').innerHTML = `
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-body text-center py-4">
                            <i class="fas fa-exclamation-circle text-warning fa-3x mb-3"></i>
                            <h4>No Soil Test Data Found</h4>
                            <p>Please submit soil test data to get crop recommendations.</p>
                            <a href="{{ url_for('soil_test') }}" class="btn btn-primary mt-2">
                                <i class="fas fa-flask me-2"></i>Enter Soil Test Data
                            </a>
                        </div>
                    </div>
                </div>
            `;
            return;
        }
        
        // Simulate processing and display results after a delay
        setTimeout(() => {
            // Hide loading and show results
            document.getElementById('recommendations-container').classList.add('d-none');
            document.getElementById('recommendations-result').classList.remove('d-none');
            
            // Display soil summary
            displaySoilSummary(soilTestData);
            
            // Generate and display crop recommendations
            const recommendations = generateCropRecommendations(soilTestData);
            displayCropRecommendations(recommendations);
            
            // Display soil improvement recommendations
            displaySoilImprovements(soilTestData);
            
            // Setup event handlers
            setupEventHandlers(recommendations, soilTestData);
        }, 2000);
        
        function generateCropRecommendations(soilData) {
            // In a real implementation, this would use the ML model
            // For now, we'll use simple rules based on soil parameters
            
            // Sample crop recommendations
            return [
                {
                    name: "Wheat",
                    score: 92,
                    description: "Wheat thrives in your soil conditions with excellent nitrogen and phosphorus levels.",
                    image: "https://pixabay.com/get/gcd54fdc85eaf0e45df89cf5aec90010a61e011471b00306cc26025aae50f160700036184e1c4733d03de4163b02b1757564e30c582b09cd9862c6728958a112f_1280.jpg",
                    process: {
                        seedSelection: "Choose high-quality, disease-resistant wheat varieties suitable for your region. Common varieties include Hard Red Winter Wheat, Soft Red Winter Wheat, or Spring Wheat.",
                        landPreparation: "Plow to a depth of 6-8 inches and prepare a fine seedbed. Remove weeds and level the field. Apply base fertilizer according to soil test recommendations.",
                        planting: "Plant seeds at a depth of 1-1.5 inches with row spacing of 6-7 inches. Seed rate should be 100-125 kg/ha. Best planting time is early autumn for winter wheat or early spring for spring wheat.",
                        irrigation: "Ensure adequate moisture at planting. Critical irrigation stages are tillering, jointing, flowering, and grain filling. Avoid waterlogging.",
                        fertilization: "Apply nitrogen in split doses: 30% at planting, 40% at tillering, and 30% at heading. Apply all phosphorus and potassium at planting.",
                        pestControl: "Monitor for aphids, armyworms, and weevils. Use appropriate insecticides when threshold levels are reached.",
                        diseaseManagement: "Watch for rust, powdery mildew, and Fusarium head blight. Apply fungicides preventatively during heading and flowering stages if disease pressure is high.",
                        harvesting: "Harvest when grain moisture content is 13-14%. Combine harvester settings should be adjusted to minimize grain damage and losses."
                    }
                },
                {
                    name: "Maize (Corn)",
                    score: 88,
                    description: "Corn would grow well with your potassium levels and soil pH.",
                    image: "https://pixabay.com/get/g2acaab70ccf39605b45327c286f70942d36a65166167733d1bb84c75583b3127ab071d5e8dcab7d8bc41c1e64a3196e4529724eeff4db3c62e8c48fb5361870d_1280.jpg",
                    process: {
                        seedSelection: "Select hybrid varieties suited to your region and purpose (grain or silage). Consider disease resistance and maturity days.",
                        landPreparation: "Deep plow to 8-10 inches and create a well-pulverized seedbed. Remove crop residues or incorporate them well. Apply lime if pH is below 5.8.",
                        planting: "Plant seeds 1.5-2 inches deep with row spacing of 30 inches and plant spacing of 8-10 inches. Seed rate should be 20-25 kg/ha. Plant when soil temperature reaches 50°F (10°C).",
                        irrigation: "Critical watering periods are during tasseling, silking, and grain filling. Maintain adequate soil moisture without waterlogging.",
                        fertilization: "Apply 30% nitrogen, all phosphorus and potassium at planting. Side-dress remaining nitrogen when plants are knee-high. Total N requirement is 150-180 kg/ha.",
                        pestControl: "Monitor for corn borers, armyworms, and rootworms. Apply insecticides when threshold levels are reached or use Bt corn varieties.",
                        diseaseManagement: "Watch for northern corn leaf blight, gray leaf spot, and stalk rots. Use resistant varieties and crop rotation to minimize disease pressure.",
                        harvesting: "Harvest for grain when kernels show black layer formation and moisture is 23-25%. Harvest for silage at 65-70% moisture when kernels are at dough stage."
                    }
                },
                {
                    name: "Soybeans",
                    score: 85,
                    description: "Soybeans are well-suited to your soil's phosphorus content and pH level.",
                    image: "https://pixabay.com/get/g9da06a235b05b14ff32df2e8270e44594d2f3b3fa9f1b338a3ccd3cc87467a0f0d17a7b872160496e21b6cca974b54073fdf3a79595d6b5810072766eb06393e_1280.jpg",
                    process: {
                        seedSelection: "Choose varieties appropriate for your latitude and growing season length. Consider disease resistance packages and maturity groups.",
                        landPreparation: "Till to a depth of 6-8 inches and prepare a smooth seedbed. Ensure good drainage. Apply lime if pH is below 6.0.",
                        planting: "Plant seeds 1-1.5 inches deep with row spacing of 15-30 inches. Seed rate should be 80-100 kg/ha. Plant when soil temperature is at least 55°F (13°C).",
                        irrigation: "Critical water needs are during flowering and pod filling. Maintain consistent soil moisture during reproductive stages.",
                        fertilization: "Soybeans require less nitrogen due to nitrogen fixation. Apply phosphorus and potassium according to soil test. A starter fertilizer with low N may benefit early growth.",
                        pestControl: "Monitor for soybean aphids, bean leaf beetles, and stink bugs. Apply insecticides when threshold levels are reached.",
                        diseaseManagement: "Watch for sudden death syndrome, white mold, and soybean cyst nematode. Use resistant varieties and crop rotation to manage diseases.",
                        harvesting: "Harvest when seed moisture is 13-15%. Combine when pods are brown and seeds rattle in the pods. Adjust combine settings to minimize seed damage."
                    }
                },
                {
                    name: "Potatoes",
                    score: 79,
                    description: "Potatoes could perform well with some additional potassium amendments.",
                    image: "https://pixabay.com/get/g5c3de924a541b23e6b40d0c2227998ebd98a2f0eb4322f03d43deac05634b4fadd6291325588049fcdc68a5ab760f64b793d1c10849d23f0dfb28b149beca176_1280.jpg",
                    process: {
                        seedSelection: "Use certified disease-free seed potatoes. Cut large tubers into pieces with at least 2-3 eyes each. Allow cut surfaces to heal for 1-2 days before planting.",
                        landPreparation: "Plow deeply (8-10 inches) and prepare a loose, friable seedbed. Incorporate organic matter to improve soil structure. Apply lime if pH is below 5.0.",
                        planting: "Plant seed pieces 3-4 inches deep with row spacing of 30-36 inches and seed spacing of 9-12 inches. Plant when soil temperature is at least 45°F (7°C).",
                        irrigation: "Maintain consistent soil moisture, especially during tuber initiation and bulking. Avoid water stress that can lead to misshapen tubers.",
                        fertilization: "Apply nitrogen in split applications: at planting and at hilling. High potassium is essential for potato quality. Apply 120-150 kg/ha N, 100-120 kg/ha P, and 150-180 kg/ha K.",
                        pestControl: "Monitor for Colorado potato beetles, aphids, and leafhoppers. Use appropriate insecticides and consider row covers for early season protection.",
                        diseaseManagement: "Watch for late blight, early blight, and scab. Use fungicides preventatively during wet periods. Maintain good air circulation by proper spacing.",
                        harvesting: "Harvest after vines have died naturally or been killed. Dig carefully to avoid damaging tubers. Allow harvested potatoes to cure at 50-60°F (10-15°C) with high humidity for 10-14 days."
                    }
                },
                {
                    name: "Rice",
                    score: 72,
                    description: "Rice is a possibility with your current soil, but may need additional nitrogen.",
                    image: "https://pixabay.com/get/g564c9ce37e679a2bfedb365dfac837af20df0cf3cb001d31d519b72f4c238a573b1e7d1b0f0df97bb3e313f8cf61a21138566e67138820fe461b8cea5bb91a44_1280.jpg",
                    process: {
                        seedSelection: "Select varieties suited to your region and growing method (lowland or upland). Consider disease resistance and grain quality traits.",
                        landPreparation: "For lowland rice, plow and puddle the soil to create a fine, level seedbed with a hardpan beneath. For upland rice, prepare a well-drained seedbed.",
                        planting: "For transplanted rice, raise seedlings for 20-30 days before transplanting. For direct seeding, sow pre-germinated seeds onto prepared fields. Plant spacing is typically 20 x 20 cm.",
                        irrigation: "Maintain 2-5 cm water depth during vegetative stage. Drain field for 7-10 days at maximum tillering. Flood again during reproductive stage. Drain 2-3 weeks before harvest.",
                        fertilization: "Apply nitrogen in 3 splits: at planting, active tillering, and panicle initiation. Apply all phosphorus at planting and potassium in 2 splits.",
                        pestControl: "Monitor for stem borers, plant hoppers, and leaf folders. Use integrated pest management practices including resistant varieties.",
                        diseaseManagement: "Watch for blast, bacterial leaf blight, and sheath blight. Use resistant varieties and proper water management to reduce disease pressure.",
                        harvesting: "Harvest when 80-85% of grains are straw-colored. Moisture content should be around 20-25%. Dry to 14% moisture for storage."
                    }
                }
            ];
        }
        
        function displayCropRecommendations(recommendations) {
            const cropList = document.getElementById('crop-list');
            cropList.innerHTML = '';
            
            recommendations.forEach((crop, index) => {
                const item = document.createElement('a');
                item.href = '#selected-crop-card';
                item.className = 'list-group-item list-group-item-action d-flex align-items-center';
                item.setAttribute('data-crop-index', index);
                
                item.innerHTML = `
                    <div class="flex-shrink-0">
                        <div class="crop-score-badge">${crop.score}</div>
                    </div>
                    <div class="ms-3 me-auto">
                        <h5 class="mb-1">${crop.name}</h5>
                        <p class="mb-0 text-muted">${crop.description}</p>
                    </div>
                    <i class="fas fa-chevron-right text-muted"></i>
                `;
                
                cropList.appendChild(item);
                
                // Add event listener to display crop details when clicked
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const index = this.getAttribute('data-crop-index');
                    displayCropDetails(recommendations[index]);
                    
                    // Remove active class from all items and add to clicked one
                    document.querySelectorAll('#crop-list a').forEach(el => {
                        el.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Scroll to crop details
                    document.getElementById('selected-crop-card').scrollIntoView({
                        behavior: 'smooth'
                    });
                });
            });
            
            // Display the first crop details by default
            if (recommendations.length > 0) {
                displayCropDetails(recommendations[0]);
                document.querySelector('#crop-list a').classList.add('active');
            }
        }
        
        function displayCropDetails(crop) {
            const cropDetails = document.getElementById('crop-details');
            document.getElementById('selected-crop-title').textContent = crop.name + ' Growing Guide';
            
            let varietiesHtml = '';
            if (crop.varieties && crop.varieties.length > 0) {
                varietiesHtml = `
                    <div class="mt-4">
                        <h5 class="border-bottom pb-2 mb-3">Varieties</h5>
                        <div class="row">
                            ${crop.varieties.map(variety => `
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="card-title">${variety.name}</h6>
                                            <p class="card-text small mb-1">${variety.description}</p>
                                            <span class="badge bg-info text-white">Adaptability: ${variety.adaptability}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            let storageHtml = '';
            if (crop.process.storage) {
                storageHtml = `
                    <div class="timeline-item">
                        <div class="timeline-marker bg-info">
                            <i class="fas fa-warehouse"></i>
                        </div>
                        <div class="timeline-content">
                            <h5>Storage</h5>
                            <p>${crop.process.storage}</p>
                        </div>
                    </div>
                `;
            }
            
            let cropRotationHtml = '';
            if (crop.process.cropRotation) {
                cropRotationHtml = `
                    <div class="timeline-item">
                        <div class="timeline-marker bg-secondary">
                            <i class="fas fa-sync-alt"></i>
                        </div>
                        <div class="timeline-content">
                            <h5>Crop Rotation</h5>
                            <p>${crop.process.cropRotation}</p>
                        </div>
                    </div>
                `;
            }
            
            cropDetails.innerHTML = `
                <div class="row mb-4">
                    <div class="col-md-4">
                        <img src="${crop.image}" alt="${crop.name}" class="img-fluid rounded">
                        <div class="mt-3">
                            <div class="d-flex align-items-center mb-2">
                                <div class="crop-score-badge me-2">${crop.score}</div>
                                <span>Compatibility Score</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <h4>${crop.name}</h4>
                        <p>${crop.description}</p>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6><i class="fas fa-cloud-sun text-info me-2"></i>Climate</h6>
                                <p class="small">${crop.climate || 'Information not available'}</p>
                                
                                <h6><i class="fas fa-calendar-alt text-success me-2"></i>Growing Season</h6>
                                <p class="small">${crop.growingSeason || 'Information not available'}</p>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-chart-line text-warning me-2"></i>Yield Potential</h6>
                                <p class="small">${crop.yieldPotential || 'Information not available'}</p>
                                
                                <h6><i class="fas fa-apple-alt text-danger me-2"></i>Nutritional Value</h6>
                                <p class="small">${crop.nutritionalValue || 'Information not available'}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <ul class="nav nav-tabs mb-4" id="cropDetailTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="growing-tab" data-bs-toggle="tab" data-bs-target="#growing-content" type="button" role="tab">
                            Growing Process
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="requirements-tab" data-bs-toggle="tab" data-bs-target="#requirements-content" type="button" role="tab">
                            Growing Requirements
                        </button>
                    </li>
                    ${crop.varieties && crop.varieties.length > 0 ? `
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="varieties-tab" data-bs-toggle="tab" data-bs-target="#varieties-content" type="button" role="tab">
                            Varieties
                        </button>
                    </li>
                    ` : ''}
                </ul>
                
                <div class="tab-content" id="cropDetailTabsContent">
                    <div class="tab-pane fade show active" id="growing-content" role="tabpanel">
                        <h5 class="border-bottom pb-2 mb-3">Complete Growing Process</h5>
                        
                        <div class="timeline">
                            <div class="timeline-item">
                                <div class="timeline-marker bg-primary">
                                    <i class="fas fa-leaf"></i>
                                </div>
                                <div class="timeline-content">
                                    <h5>Seed Selection</h5>
                                    <p>${crop.process.seedSelection}</p>
                                </div>
                            </div>
                            
                            <div class="timeline-item">
                                <div class="timeline-marker bg-secondary">
                                    <i class="fas fa-tractor"></i>
                                </div>
                                <div class="timeline-content">
                                    <h5>Land Preparation</h5>
                                    <p>${crop.process.landPreparation}</p>
                                </div>
                            </div>
                            
                            <div class="timeline-item">
                                <div class="timeline-marker bg-success">
                                    <i class="fas fa-seedling"></i>
                                </div>
                                <div class="timeline-content">
                                    <h5>Planting</h5>
                                    <p>${crop.process.planting}</p>
                                </div>
                            </div>
                            
                            <div class="timeline-item">
                                <div class="timeline-marker bg-info">
                                    <i class="fas fa-tint"></i>
                                </div>
                                <div class="timeline-content">
                                    <h5>Irrigation</h5>
                                    <p>${crop.process.irrigation}</p>
                                </div>
                            </div>
                            
                            <div class="timeline-item">
                                <div class="timeline-marker bg-warning">
                                    <i class="fas fa-flask"></i>
                                </div>
                                <div class="timeline-content">
                                    <h5>Fertilization</h5>
                                    <p>${crop.process.fertilization}</p>
                                </div>
                            </div>
                            
                            <div class="timeline-item">
                                <div class="timeline-marker bg-danger">
                                    <i class="fas fa-bug"></i>
                                </div>
                                <div class="timeline-content">
                                    <h5>Pest Control</h5>
                                    <p>${crop.process.pestControl}</p>
                                </div>
                            </div>
                            
                            <div class="timeline-item">
                                <div class="timeline-marker bg-primary">
                                    <i class="fas fa-shield-alt"></i>
                                </div>
                                <div class="timeline-content">
                                    <h5>Disease Management</h5>
                                    <p>${crop.process.diseaseManagement}</p>
                                </div>
                            </div>
                            
                            <div class="timeline-item">
                                <div class="timeline-marker bg-success">
                                    <i class="fas fa-cut"></i>
                                </div>
                                <div class="timeline-content">
                                    <h5>Harvesting</h5>
                                    <p>${crop.process.harvesting}</p>
                                </div>
                            </div>
                            
                            ${storageHtml}
                            
                            ${cropRotationHtml}
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="requirements-content" role="tabpanel">
                        <h5 class="border-bottom pb-2 mb-3">Growing Requirements</h5>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Soil Requirements</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <strong>Nitrogen:</strong> ${Math.round((crop.requirements.nitrogen || crop.requirements.N || 0.5) * 100)}% of maximum
                                        </div>
                                        <div class="mb-2">
                                            <strong>Phosphorus:</strong> ${Math.round((crop.requirements.phosphorus || crop.requirements.P || 0.5) * 100)}% of maximum
                                        </div>
                                        <div class="mb-2">
                                            <strong>Potassium:</strong> ${Math.round((crop.requirements.potassium || crop.requirements.K || 0.5) * 100)}% of maximum
                                        </div>
                                        <div class="mb-2">
                                            <strong>pH Range:</strong> ${crop.requirements.phRange ? crop.requirements.phRange.join(' - ') : 'Not specified'}
                                        </div>
                                        <div class="mb-2">
                                            <strong>EC Range:</strong> ${crop.requirements.ecRange ? crop.requirements.ecRange.join(' - ') + ' dS/m' : 'Not specified'}
                                        </div>
                                        <div class="mb-2">
                                            <strong>Organic Matter:</strong> ${crop.requirements.organicMatter ? crop.requirements.organicMatter + '%' : 'Not specified'}
                                        </div>
                                        <div>
                                            <strong>Suitable Soil Textures:</strong> 
                                            ${crop.requirements.soilTextures ? crop.requirements.soilTextures.map(texture => 
                                                `<span class="badge bg-secondary me-1">${texture}</span>`
                                            ).join('') : 'Not specified'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Climate Requirements</h6>
                                    </div>
                                    <div class="card-body">
                                        ${crop.requirements.temperature ? `
                                        <div class="mb-2">
                                            <strong>Germination Temperature:</strong> ${crop.requirements.temperature.germination}
                                        </div>
                                        <div class="mb-2">
                                            <strong>Growth Temperature:</strong> ${crop.requirements.temperature.growth}
                                        </div>
                                        <div class="mb-2">
                                            <strong>Optimal Temperature:</strong> ${crop.requirements.temperature.optimal}
                                        </div>
                                        ` : ''}
                                        <div>
                                            <strong>Water Requirement:</strong> ${crop.requirements.waterRequirement || 'Not specified'}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Compatibility with Your Soil</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="crop-score-badge me-2">${crop.score}</div>
                                            <span>Overall Compatibility Score</span>
                                        </div>
                                        <p class="small mt-2">This score indicates how well this crop matches your soil test results, with 100 being a perfect match.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${crop.varieties && crop.varieties.length > 0 ? `
                    <div class="tab-pane fade" id="varieties-content" role="tabpanel">
                        <h5 class="border-bottom pb-2 mb-3">${crop.name} Varieties</h5>
                        
                        <div class="row">
                            ${crop.varieties.map(variety => `
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">${variety.name}</h6>
                                        </div>
                                        <div class="card-body">
                                            <p>${variety.description}</p>
                                            <div class="mt-2">
                                                <strong>Regional Adaptability:</strong>
                                                <p class="small">${variety.adaptability}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        }
        
        function displaySoilSummary(soilData) {
            const soilSummary = document.getElementById('soil-summary');
            
            // Create a function to determine soil quality level
            function getQualityClass(value, low, medium, high) {
                value = Number(value) || 0;
                if (value < low) return 'text-danger';
                if (value < medium) return 'text-warning';
                if (value < high) return 'text-success';
                return 'text-primary';
            }
            
            // Format the soil summary
            soilSummary.innerHTML = `
                <h5>${soilData.location || 'Your Field'}</h5>
                <p class="text-muted mb-3">Area: ${soilData.area || soilData.landArea || '1'} acres</p>
                
                <h6>Macronutrients</h6>
                <div class="row g-2 mb-3">
                    <div class="col-4">
                        <div class="card bg-light">
                            <div class="card-body p-2 text-center">
                                <h6 class="mb-0 ${getQualityClass(soilData.N || 0, 40, 80, 120)}">N</h6>
                                <small>${soilData.N || 0} kg/ha</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="card bg-light">
                            <div class="card-body p-2 text-center">
                                <h6 class="mb-0 ${getQualityClass(soilData.P || 0, 20, 40, 60)}">P</h6>
                                <small>${soilData.P || 0} kg/ha</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="card bg-light">
                            <div class="card-body p-2 text-center">
                                <h6 class="mb-0 ${getQualityClass(soilData.K || 0, 30, 60, 90)}">K</h6>
                                <small>${soilData.K || 0} kg/ha</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h6>Soil Properties</h6>
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <div class="card bg-light">
                            <div class="card-body p-2 text-center">
                                <h6 class="mb-0 ${soilData.ph < 5.5 || soilData.ph > 7.5 ? 'text-warning' : 'text-success'}">pH</h6>
                                <small>${soilData.ph}</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-light">
                            <div class="card-body p-2 text-center">
                                <h6 class="mb-0">Texture</h6>
                                <small>${soilData.soilTexture || 'Unknown'}</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h6>Micronutrients</h6>
                <div class="row g-2">
                    <div class="col-4">
                        <div class="card bg-light">
                            <div class="card-body p-2 text-center">
                                <h6 class="mb-0">Zn</h6>
                                <small>${soilData.zinc || 'N/A'} ppm</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="card bg-light">
                            <div class="card-body p-2 text-center">
                                <h6 class="mb-0">Fe</h6>
                                <small>${soilData.iron || 'N/A'} ppm</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="card bg-light">
                            <div class="card-body p-2 text-center">
                                <h6 class="mb-0">B</h6>
                                <small>${soilData.boron || 'N/A'} ppm</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function displaySoilImprovements(soilData) {
            const improvementsList = document.getElementById('soil-improvements');
            const improvements = [];
            
            // Check nitrogen levels
            const N = Number(soilData.N || 0);
            if (N < 40) {
                improvements.push("Apply nitrogen fertilizer: Add 40-60 kg/ha of nitrogen. Consider using a combination of fast-acting and slow-release fertilizers.");
            } else if (N > 120) {
                improvements.push("Reduce nitrogen inputs: Your soil has high nitrogen levels. Consider planting nitrogen-hungry crops or adding carbon-rich materials to balance the C:N ratio.");
            }
            
            // Check phosphorus levels
            const P = Number(soilData.P || 0);
            if (P < 20) {
                improvements.push("Increase phosphorus: Apply 30-40 kg/ha of phosphate fertilizer. Rock phosphate or bone meal are good organic options.");
            }
            
            // Check potassium levels
            const K = Number(soilData.K || 0);
            if (K < 30) {
                improvements.push("Add potassium: Apply 30-40 kg/ha of potash. Wood ash or potassium sulfate can be used to increase levels.");
            }
            
            // Check pH
            if (soilData.ph < 5.5) {
                improvements.push("Raise soil pH: Apply agricultural lime at 2-4 tons/ha to increase pH for better nutrient availability.");
            } else if (soilData.ph > 7.5) {
                improvements.push("Lower soil pH: Add organic matter such as peat moss, composted leaves, or elemental sulfur to gradually reduce pH.");
            }
            
            // Display improvements
            if (improvements.length === 0) {
                improvements.push("Your soil conditions are generally good for many crops. Focus on maintaining current levels through proper crop rotation and organic matter management.");
            }
            
            improvementsList.innerHTML = improvements.map(improvement => `<li>${improvement}</li>`).join('');
        }
        
        function setupEventHandlers(recommendations, soilData) {
            // Get crop list element
            const cropList = document.getElementById('crop-list');
            
            // Clear existing items
            cropList.innerHTML = '';
            
            // Add recommendations to the list
            recommendations.forEach((crop, index) => {
                const cropItem = document.createElement('a');
                cropItem.href = '#';
                cropItem.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                cropItem.dataset.index = index;
                
                // Set active class for the first item
                if (index === 0) {
                    cropItem.classList.add('active');
                    // Display the first crop's details
                    displayCropDetails(crop);
                }
                
                cropItem.innerHTML = `
                    <div>
                        <h5 class="mb-1">${crop.name}</h5>
                        <p class="mb-1 text-muted small">${crop.description.substring(0, 60)}...</p>
                    </div>
                    <span class="badge bg-success rounded-pill">${crop.score}%</span>
                `;
                
                // Add click event listener to display crop details
                cropItem.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all items
                    cropList.querySelectorAll('a').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // Add active class to clicked item
                    this.classList.add('active');
                    
                    // Get the crop index from the data attribute
                    const cropIndex = parseInt(this.dataset.index);
                    
                    // Display the selected crop's details
                    displayCropDetails(recommendations[cropIndex]);
                });
                
                cropList.appendChild(cropItem);
            });
            
            // Setup PDF download button
            document.getElementById('download-pdf').addEventListener('click', function() {
                // Get the active crop
                const activeIndex = parseInt(document.querySelector('#crop-list a.active').dataset.index);
                generatePDF(recommendations[activeIndex], soilData);
            });
        }
        
        function displayCropDetails(crop) {
            const cropDetails = document.getElementById('crop-details');
            const selectedCropTitle = document.getElementById('selected-crop-title');
            
            // Update the title
            selectedCropTitle.textContent = crop.name;
            
            // Prepare storage and crop rotation sections if available
            const storageHtml = crop.process.storage ? `
                <div class="timeline-item">
                    <div class="timeline-marker bg-info">
                        <i class="fas fa-warehouse"></i>
                    </div>
                    <div class="timeline-content">
                        <h5>Storage</h5>
                        <p>${crop.process.storage}</p>
                    </div>
                </div>
            ` : '';
            
            const cropRotationHtml = crop.process.cropRotation ? `
                <div class="timeline-item">
                    <div class="timeline-marker bg-secondary">
                        <i class="fas fa-sync-alt"></i>
                    </div>
                    <div class="timeline-content">
                        <h5>Crop Rotation</h5>
                        <p>${crop.process.cropRotation}</p>
                    </div>
                </div>
            ` : '';
            
            // Update the details section
            cropDetails.innerHTML = `
                <div class="row mb-4">
                    <div class="col-md-4">
                        <img src="${crop.image}" alt="${crop.name}" class="img-fluid rounded">
                    </div>
                    <div class="col-md-8">
                        <h4>${crop.name}</h4>
                        <div class="d-flex align-items-center mb-2">
                            <div class="me-3">
                                <span class="badge bg-success p-2">
                                    <i class="fas fa-check-circle me-1"></i>${crop.score}% Match
                                </span>
                            </div>
                            <div class="progress flex-grow-1" style="height: 8px;">
                                <div class="progress-bar bg-success" role="progressbar" style="width: ${crop.score}%" aria-valuenow="${crop.score}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                        <p>${crop.description}</p>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Soil Requirements</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <strong>Nitrogen:</strong> ${Math.round((crop.requirements?.nitrogen || crop.requirements?.N || 0.5) * 100)}% of maximum
                                        </div>
                                        <div class="mb-2">
                                            <strong>Phosphorus:</strong> ${Math.round((crop.requirements?.phosphorus || crop.requirements?.P || 0.5) * 100)}% of maximum
                                        </div>
                                        <div class="mb-2">
                                            <strong>Potassium:</strong> ${Math.round((crop.requirements?.potassium || crop.requirements?.K || 0.5) * 100)}% of maximum
                                        </div>
                                        <div class="mb-2">
                                            <strong>pH Range:</strong> ${crop.requirements?.phRange ? crop.requirements.phRange.join(' - ') : '6.0 - 7.0'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Growing Season</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <strong>Planting Time:</strong> ${crop.season?.planting || 'Spring'}
                                        </div>
                                        <div class="mb-2">
                                            <strong>Harvest Time:</strong> ${crop.season?.harvest || 'Fall'}
                                        </div>
                                        <div class="mb-2">
                                            <strong>Growth Duration:</strong> ${crop.season?.growthDuration || '90-120 days'}
                                        </div>
                                        <div class="mb-2">
                                            <strong>Climate:</strong> ${crop.season?.climate || 'Temperate'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h5 class="border-bottom pb-2 mb-3">Growing Process</h5>
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-marker bg-primary">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <div class="timeline-content">
                            <h5>Seed Selection</h5>
                            <p>${crop.process.seedSelection}</p>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="timeline-marker bg-success">
                            <i class="fas fa-tractor"></i>
                        </div>
                        <div class="timeline-content">
                            <h5>Land Preparation</h5>
                            <p>${crop.process.landPreparation}</p>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="timeline-marker bg-info">
                            <i class="fas fa-hand-holding-medical"></i>
                        </div>
                        <div class="timeline-content">
                            <h5>Planting</h5>
                            <p>${crop.process.planting}</p>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="timeline-marker bg-primary">
                            <i class="fas fa-tint"></i>
                        </div>
                        <div class="timeline-content">
                            <h5>Irrigation</h5>
                            <p>${crop.process.irrigation}</p>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="timeline-marker bg-warning">
                            <i class="fas fa-flask"></i>
                        </div>
                        <div class="timeline-content">
                            <h5>Fertilization</h5>
                            <p>${crop.process.fertilization}</p>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="timeline-marker bg-danger">
                            <i class="fas fa-bug"></i>
                        </div>
                        <div class="timeline-content">
                            <h5>Pest Control</h5>
                            <p>${crop.process.pestControl}</p>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="timeline-marker bg-primary">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="timeline-content">
                            <h5>Disease Management</h5>
                            <p>${crop.process.diseaseManagement}</p>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="timeline-marker bg-success">
                            <i class="fas fa-cut"></i>
                        </div>
                        <div class="timeline-content">
                            <h5>Harvesting</h5>
                            <p>${crop.process.harvesting}</p>
                        </div>
                    </div>
                    
                    ${storageHtml}
                    
                    ${cropRotationHtml}
                </div>
            `;
        }
        
        function generatePDF(crop, soilData) {
            // Use jsPDF to generate PDF
            const { jsPDF } = window.jspdf;
            
            const doc = new jsPDF();
            
            // Add header
            doc.setFontSize(20);
            doc.text('Crop Recommendation Report', 105, 20, { align: 'center' });
            
            // Add soil data summary
            doc.setFontSize(16);
            doc.text('Soil Analysis', 20, 40);
            
            doc.setFontSize(12);
            doc.text(`Location: ${soilData.location || 'Your Field'}`, 20, 50);
            doc.text(`Land Area: ${soilData.area || soilData.landArea || '1'} acres`, 20, 60);
            doc.text(`N-P-K Values: ${soilData.N || 0}-${soilData.P || 0}-${soilData.K || 0}`, 20, 70);
            doc.text(`pH: ${soilData.ph || 7.0}`, 20, 80);
            
            // Add recommended crop info
            doc.setFontSize(16);
            doc.text('Top Recommended Crop', 20, 100);
            
            doc.setFontSize(14);
            doc.text(`${crop.name} (Compatibility Score: ${crop.score}%)`, 20, 110);
            
            doc.setFontSize(12);
            doc.text(crop.description, 20, 120);
            
            // Add growing process
            doc.setFontSize(16);
            doc.text('Growing Process', 20, 140);
            
            let y = 150;
            const lineHeight = 10;
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Seed Selection:', 20, y);
            doc.setFont(undefined, 'normal');
            
            // Split text to fit page width
            const splitSeed = doc.splitTextToSize(crop.process.seedSelection, 170);
            doc.text(splitSeed, 20, y + lineHeight);
            y += lineHeight * (splitSeed.length + 1);
            
            doc.setFont(undefined, 'bold');
            doc.text('Land Preparation:', 20, y);
            doc.setFont(undefined, 'normal');
            const splitLand = doc.splitTextToSize(crop.process.landPreparation, 170);
            doc.text(splitLand, 20, y + lineHeight);
            y += lineHeight * (splitLand.length + 1);
            
            // Add a new page if needed
            if (y > 270) {
                doc.addPage();
                y = 20;
            }
            
            doc.setFont(undefined, 'bold');
            doc.text('Planting:', 20, y);
            doc.setFont(undefined, 'normal');
            const splitPlanting = doc.splitTextToSize(crop.process.planting, 170);
            doc.text(splitPlanting, 20, y + lineHeight);
            y += lineHeight * (splitPlanting.length + 1);
            
            // Continue adding other process steps...
            
            // Footer
            doc.setFontSize(10);
            doc.text('Generated by AgroAssist - Offline Smart Farming Solution', 105, 280, { align: 'center' });
            
            // Save the PDF
            doc.save(`Crop_Recommendation_${crop.name}.pdf`);
        }
    });
</script>

<style>
    .crop-score-badge {
        width: 40px;
        height: 40px;
        background-color: #198754;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }
    
    .timeline {
        position: relative;
        padding-left: 30px;
    }
    
    .timeline-item {
        position: relative;
        padding-bottom: 20px;
    }
    
    .timeline::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 0;
        height: 100%;
        width: 2px;
        background-color: #dee2e6;
    }
    
    .timeline-marker {
        position: absolute;
        left: -30px;
        top: 0;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        text-align: center;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .timeline-content {
        border-left: 2px solid #f8f9fa;
        padding-left: 15px;
    }
</style>
{% endblock %}
